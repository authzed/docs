name: "Claude Code"
# Note: only users with write permissions can invoke Claude jobs

"on":
  issue_comment:
    types: ["created"]
  pull_request_review_comment:
    types: ["created"]
  issues:
    types: ["opened", "labeled"]
  pull_request_review:
    types: ["submitted"]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to process"
        required: true
        type: "number"
      dry_run:
        description: "Dry run - analyze and report without making changes"
        required: false
        type: "boolean"
        default: false

jobs:
  # Disable general claude invocations
  # claude:
  #   if: |
  #     (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
  #     (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
  #     (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
  #     (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     pull-requests: read
  #     issues: read
  #     id-token: write
  #     actions: read # Required for Claude to read CI results on PRs
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1
  #
  #     - name: Run Claude Code
  #       id: claude
  #       uses: anthropics/claude-code-action@v1
  #       with:
  #         anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
  #
  #         # This is an optional setting that allows Claude to read CI results on PRs
  #         additional_permissions: |
  #           actions: read
  #
  #         # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
  #         # prompt: 'Update the pull request description to include a summary of changes.'
  #
  #         # Optional: Add claude_args to customize behavior and configuration
  #         # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
  #         # or https://code.claude.com/docs/en/cli-reference for available options
  #         # claude_args: '--allowed-tools Bash(gh pr:*)'

  suggestion:
    name: "Suggestion Handler"
    # Concurrency: only one run per issue at a time
    concurrency:
      group: doc-suggestion-${{ github.event.issue.number || inputs.issue_number }}
      cancel-in-progress: false
    if: |
      (github.event_name == 'issues' &&
       github.event.action == 'opened' &&
       contains(github.event.issue.labels.*.name, 'Docs') &&
       contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.issue.author_association)) ||
      (github.event_name == 'issues' &&
       github.event.action == 'labeled' &&
       contains(github.event.issue.labels.*.name, 'approved') &&
       github.event.sender.type == 'User') ||
      github.event_name == 'workflow_dispatch'
    runs-on: "ubuntu-latest"
    permissions:
      contents: "write"
      pull-requests: "write"
      issues: "write"
      # id-token: write - only needed if using OIDC auth instead of API key
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 1

      - name: "Validate label adder is org member"
        if: "github.event_name == 'issues' && github.event.action == 'labeled'"
        env:
          GH_TOKEN: "${{ github.token }}"
          SENDER: "${{ github.event.sender.login }}"
        run: |
          set -euo pipefail

          # Check if the person who added the label is an org member
          # This prevents external users with triage access from triggering
          ORG="authzed"
          if ! gh api "orgs/$ORG/members/$SENDER" > /dev/null 2>&1; then
            echo "::error::User $SENDER is not a member of $ORG organization"
            echo "::error::Only org members can approve documentation requests"
            exit 1
          fi
          echo "Label added by org member: $SENDER"

      - name: "Validate issue for manual trigger"
        if: "github.event_name == 'workflow_dispatch'"
        env:
          GH_TOKEN: "${{ github.token }}"
          ISSUE_NUMBER: "${{ inputs.issue_number }}"
          DRY_RUN: "${{ inputs.dry_run }}"
        run: |
          set -euo pipefail

          # Check if issue exists and is accessible
          if ! error_output=$(gh issue view "$ISSUE_NUMBER" --json number 2>&1); then
            echo "::error::Cannot access issue #$ISSUE_NUMBER"
            echo "::error::GitHub CLI error: $error_output"
            exit 1
          fi
          echo "Issue #$ISSUE_NUMBER found"

          # For non-dry-run, require 'approved' label
          if [ "$DRY_RUN" != "true" ]; then
            if ! labels_output=$(gh issue view "$ISSUE_NUMBER" --json labels --jq '.labels[].name' 2>&1); then
              echo "::error::Failed to fetch labels for issue #$ISSUE_NUMBER: $labels_output"
              exit 1
            fi

            if ! echo "$labels_output" | grep -q "approved"; then
              echo "::error::Issue #$ISSUE_NUMBER does not have the 'approved' label"
              echo "Use dry_run=true to test without the label, or add the 'approved' label first"
              exit 1
            fi
            echo "Issue has 'approved' label, proceeding with execution..."
          else
            echo "Dry run mode - skipping label check"
          fi

      # Max turns set to 50 based on observations; increase if sessions fail to complete
      - name: "Run Claude Code for Suggestion"
        id: "claude-suggestion"
        timeout-minutes: 30
        uses: "anthropics/claude-code-action@v1"
        env:
          ISSUE_NUMBER: "${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}"
          # Force boolean to string to avoid type coercion issues
          DRY_RUN: "${{ (github.event_name == 'workflow_dispatch' && inputs.dry_run == true) && 'true' || 'false' }}"
          # For labeled events, use the label adder as reviewer; otherwise issue author
          REVIEWER: "${{ github.event.action == 'labeled' && github.event.sender.login || (github.event_name == 'workflow_dispatch' && github.actor || github.event.issue.user.login) }}"
        with:
          anthropic_api_key: "${{ secrets.ANTHROPIC_API_KEY }}"
          # Full output may expose secrets - do not enable on public repos
          # See: https://github.com/anthropics/claude-code-action/blob/main/docs/security.md
          show_full_output: false
          prompt: |
            Process documentation issue #${{ env.ISSUE_NUMBER }}.

            DRY_RUN: ${{ env.DRY_RUN }}

            If DRY_RUN is "true":
            - Analyze the issue and existing docs
            - Plan what changes you would make
            - Comment on the issue with: files to create/modify, content to add, any clarifications needed
            - DO NOT create branches, commits, or PRs
            - End with: "This was a dry run. Add the 'approved' label or re-run without dry_run to execute."

            If DRY_RUN is "false":
            1. Read the current documentation structure
            2. Review the issue description and comments
            3. Create branch: docs/issue-${{ env.ISSUE_NUMBER }}-<short-description>
            4. Implement the documentation changes
            5. Follow existing documentation style and formatting
            6. Commit with message including "Fixes #${{ env.ISSUE_NUMBER }}"
            7. Push: git push -u origin <branch-name>
            8. Create draft PR:
               gh pr create --draft --title "docs: <brief description>" --body "## Summary
               <bullet points>

               Fixes #${{ env.ISSUE_NUMBER }}

               ---
               *Generated by Claude from documentation suggestion*"
            9. Request review: gh pr edit <pr-number> --add-reviewer ${{ env.REVIEWER }}
            10. Comment on issue #${{ env.ISSUE_NUMBER }} with:
                - Summary of changes
                - PR link
                - Vercel preview: https://docs-git-<branch-with-dashes>-authzed.vercel.app
                  (e.g., branch "docs/issue-5-proxies" -> "docs-git-docs-issue-5-proxies-authzed.vercel.app")

            RESTRICTIONS:
            - Only modify documentation files (.mdx, .md) in app/
            - Only modify _meta.ts for navigation entries
            - May add components to components/ for documentation display
            - NEVER modify .github/, scripts/, or root config files (package.json, next.config.mjs, etc.)
            - If the request is out of scope, comment explaining why
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Bash(git checkout:*),Bash(git branch:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status),Bash(git diff:*),Bash(gh pr create:*),Bash(gh pr edit:*),Bash(gh issue comment:*),WebFetch(domain:docs.authzed.com)"
            --max-turns 50

      - name: "Notify on failure"
        if: failure()
        continue-on-error: true
        env:
          GH_TOKEN: "${{ github.token }}"
          ISSUE_NUMBER: "${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}"
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          # Don't fail if notification fails
          gh issue comment "$ISSUE_NUMBER" --body "## Documentation Workflow Failed

          The automated documentation workflow encountered an error and could not complete.

          **Workflow run**: $RUN_URL

          A maintainer will investigate. You can also check the workflow logs for details.

          ---
          *Automated notification from GitHub Actions*" || echo "::warning::Failed to post failure notification"

      - name: "Notify on timeout"
        if: cancelled()
        continue-on-error: true
        env:
          GH_TOKEN: "${{ github.token }}"
          ISSUE_NUMBER: "${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}"
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "## Documentation Workflow Timed Out

          The workflow was cancelled or timed out after 30 minutes.

          **Possible causes:**
          - Request is too complex (try breaking into smaller issues)
          - Claude encountered a difficult decision
          - External service was slow to respond

          **Workflow run**: $RUN_URL

          ---
          *Automated notification from GitHub Actions*" || echo "::warning::Failed to post timeout notification"
